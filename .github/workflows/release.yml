name: Release

on:
  push:
    tags: [ '**' ]  # Trigger on ALL tags; we should skip non-main branches below

permissions:
  contents: write

jobs:

  # The Gatekeeper Job: calculates flags; does not fail, just reports truth.
  check-context:
    name: Check Context
    runs-on: ubuntu-latest
    outputs:
      on_main: ${{ steps.calc.outputs.on_main }}
      is_semver: ${{ steps.calc.outputs.is_semver }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for history check

      - name: Calc Flags
        id: calc
        run: |
          # 1. Check if tag is on 'main'
          git fetch origin main
          if git merge-base --is-ancestor HEAD origin/main; then
            echo "on_main=true" >> "$GITHUB_OUTPUT"
            echo "✅ Tag is on Main"
          else
            echo "on_main=false" >> "$GITHUB_OUTPUT"
            echo "⚠️ Tag is NOT on Main"
          fi

          # 2. Check if tag is SemVer (X.Y.Z)
          if [[ "${{ github.ref_name }}" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "is_semver=true" >> "$GITHUB_OUTPUT"
            echo "✅ Tag is SemVer"
          else
            echo "is_semver=false" >> "$GITHUB_OUTPUT"
            echo "ℹ️ Tag is NOT SemVer"
          fi

  check-format:
    name: Check Format
    needs: check-context
    if: needs.check-context.outputs.on_main == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ruff format --check
        uses: astral-sh/ruff-action@v1
        with:
          args: format --check

  test-matrix:
    name: Test Matrix
    needs: [ check-context, check-format]
    if: needs.check-context.outputs.on_main == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ '3.10', '3.11', '3.12', '3.13', '3.14' ]

    permissions:
      contents: write           # ✅ Allow pushing coverage badge updates

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install deps
        run: |
          uv sync --extra test

      - name: Unit tests
        run: |
          uv run pytest --cov=c108 --cov-branch --cov-report=term --cov-report=xml:coverage-unit.xml

      - name: Doctest
        run: |
          uv run pytest --xdoctest c108 --cov=c108 --cov-branch --cov-report=term

      - name: Install Badges deps
        if: matrix.python-version == '3.12'
        run: |
          uv sync --extra badges

      - name: Update Badges
        if: matrix.python-version == '3.12'
        env:
          BADGES_WORKTREE: /tmp/badges-worktree
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x .github/scripts/*.py
          chmod +x .github/scripts/*.sh

          # Prepare the worktree and export BADGES_WORKTREE via GITHUB_ENV
          .github/scripts/git_sync.sh "badges"

          echo "BADGES_WORKTREE is ${BADGES_WORKTREE}"

          # Write badge artifacts into the worktree
          uv run python .github/scripts/update_badges_toml.py \
            --badges-dir "${BADGES_WORKTREE}/docs/badges" \
            --coverage-xml "coverage-unit.xml"

          uv run python .github/scripts/update_coverage_badge.py \
            --badges-dir "${BADGES_WORKTREE}/docs/badges"

          uv run python .github/scripts/git_commit_if_changed.py \
            --repo-dir "${BADGES_WORKTREE}" \
            "docs/badges" \
            "chore: update badges"

      - name: Upload to Codecov
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage-unit.xml
          flags: unit


  publish:
    name: Publish to PyPI
    needs: [ check-context, check-format, test-matrix ]
    if: >
      needs.check-context.outputs.on_main == 'true' &&
      needs.check-context.outputs.is_semver == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write                         # Allow writing Release to GitHub
      id-token: write                         # For PyPI Trusted Publisher auth
    environment:
      name: pypi                              # Display Deployment History
      url: https://pypi.org/p/c108

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          # Building noarch package. Should validate across all Python versions elsewhere.

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Clean dist/ dir
        run: rm -rf dist/

      - name: Build package
        run: uv build

      - name: Publish to PyPI
        # Detect the OIDC token and authenticate
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

